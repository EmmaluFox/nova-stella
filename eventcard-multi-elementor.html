<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event Cards (Dynamic) - Elementor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Scoped styles */
    .ns-eventcard-grid { display:block; gap:20px; }
    .ns-eventcard-grid .event-card { width:100%; max-width:980px; margin:0 auto 20px; box-sizing:border-box; }
    .ns-eventcard .event-card { background-color:#0a0a0a; border-radius:8px; overflow:hidden; transition:transform .3s,box-shadow .3s; border:1px solid #1a1a1a; font-family:'Space Grotesk',system-ui,-apple-system,'Segoe UI',Roboto,Arial; }
    .ns-eventcard .event-image{min-height:160px;background:#1a1a1a;display:flex;align-items:center;justify-content:center}
    .ns-eventcard .event-image img{width:100%;height:auto;object-fit:cover}
    .ns-eventcard .event-content{padding:1rem;color:#fff}
    .ns-eventcard .event-badge{display:inline-block;padding:.25rem .6rem;background:#ff4444;color:#fff;font-weight:600;border-radius:4px;margin-bottom:.5rem;text-transform:uppercase}
    .ns-eventcard .event-badge.sold-out{background:#666}
    .ns-eventcard .event-title{font-size:1.1rem;margin:.4rem 0;font-weight:600}
    .ns-eventcard .event-speaker{font-size:.95rem;color:#fff;margin-bottom:.25rem}
    .ns-eventcard .event-date,.ns-eventcard .event-location{font-size:.9rem;color:#ccc;margin-bottom:.25rem}
    .ns-eventcard .event-info{font-size:.9rem;color:#ccc;margin:.6rem 0;padding:.6rem;background:#111;border-left:3px solid #fff;border-radius:4px}
    .ns-eventcard .event-button{display:inline-block;padding:.5rem 1rem;background:#fff;color:#000;border-radius:4px;text-decoration:none;font-weight:600}
    @media (max-width:640px){ .ns-eventcard-grid .event-card{width:100%; margin-bottom:12px;} }
  </style>
</head>
<body>

<div class="ns-eventcard">
  <!-- Container where cards will be rendered -->
  <div id="ns-event-grid" class="ns-eventcard-grid" data-src="https://novastella.co.uk/wp-content/uploads/2026/02/data.json"></div>

  <!-- Template for an event card -->
  <template id="ns-event-template">
    <div class="event-card">
      <div class="event-image">
        <img src="" alt="Event image">
      </div>
      <div class="event-content">
        <span class="event-badge" aria-hidden="true"></span>
        <h3 class="event-title"></h3>
        <div class="event-speaker"></div>
        <div class="event-date"></div>
        <div class="event-location"></div>
        <div class="event-info"></div>
        <a class="event-button" href="#">Info & Booking</a>
      </div>
    </div>
  </template>

  <!-- Data is loaded from a JSON file in WordPress media instead of inline JSON.
       Default path: /wp-content/uploads/data.json
       You can override by setting `window.NS_EVENT_DATA_URL` or adding `data-src="/full/path/to/data.json"` on `#ns-event-grid`.
  -->
  <script>
    (function(){
      function renderEvents(events){
        var tpl = document.getElementById('ns-event-template');
        var grid = document.getElementById('ns-event-grid');
        if(!tpl || !grid || !Array.isArray(events)) return;
        events.forEach(function(ev){
          var node = tpl.content.cloneNode(true);
          // Field mapping: support new schema and fall back to older keys
          var img = node.querySelector('.event-image img');
          var imgSrc = ev['Image'] || ev['image'] || ev.image || '';
          if(img) img.src = imgSrc;

          var badge = node.querySelector('.event-badge');
          var status = ev['Status'] || ev['status'] || '';
          if(badge){
            if(String(status).toLowerCase() === 'sold-out' || String(status).toLowerCase() === 'sold out'){
              badge.textContent = 'Sold Out';
              badge.style.display = '';
            } else {
              badge.textContent = '';
              badge.style.display = 'none';
            }
          }

          var title = node.querySelector('.event-title');
          var titleText = ev['Talk Title'] || ev['TalkTitle'] || ev['title'] || ev['Talk_Title'] || '';
          if(title) title.textContent = titleText;

          var speakerEl = node.querySelector('.event-speaker');
          var speakerName = ev['Speaker'] || ev['speaker'] || '';
          var speakerWebsite = ev['Speaker Website'] || ev['Speaker Website'] || ev['Speaker Website'] || '';
          if(speakerEl){
            if(speakerWebsite){
              speakerEl.innerHTML = '<a href="' + (speakerWebsite.indexOf('http')===0?speakerWebsite:'https://'+speakerWebsite) + '" target="_blank" rel="noopener noreferrer">' + (speakerName || '') + '</a>';
            } else {
              speakerEl.textContent = speakerName;
            }
          }

          var dateEl = node.querySelector('.event-date');
          var dateText = ev['Date'] || ev['date'] || '';
          var startTime = ev['Start Time'] || ev['StartTime'] || ev['Start'] || '';
          if(dateEl) dateEl.textContent = startTime ? (dateText + ' â€” ' + startTime) : dateText;

          var loc = node.querySelector('.event-location');
          var venue = ev['Venue'] || ev['Venue Name'] || '';
          var address = ev['Address'] || '';
          var city = ev['City'] || '';
          var postcode = ev['Postcode'] || ev['Postcode'] || '';
          var locationText = '';
          if(venue) locationText += venue;
          if(address) locationText += (locationText? ', ' : '') + address;
          if(city) locationText += (locationText? ', ' : '') + city;
          if(postcode) locationText += (locationText? ', ' : '') + postcode;
          if(loc) loc.textContent = locationText;

          var info = node.querySelector('.event-info');
          var blurb = ev['Talk Blurb'] || ev['Talk Blurb'] || ev['TalkBlurb'] || ev['blurb'] || '';
          if(info) info.textContent = blurb;

          var a = node.querySelector('.event-button');
          var inPerson = ev['In Person Eventbrite Link'] || ev['In Person Eventbrite'] || '';
          var online = ev['Online Eventbrite Link'] || ev['Online Eventbrite'] || '';
          var fallback = ev['link'] || ev['Link'] || '#';
          var href = inPerson || online || fallback || '#';
          if(a) a.href = href;

          grid.appendChild(node);
        });
      }

      function loadData(){
        var grid = document.getElementById('ns-event-grid');
        var attrUrl = grid && grid.getAttribute('data-src');
        var url = window.NS_EVENT_DATA_URL || attrUrl || '/wp-content/uploads/data.json';
        // If the url is relative and the site uses a different base, you can provide full media URL.
        var restUrl = '/wp-json/custom/v1/data';

        function fetchJson(u){
          return fetch(u, {cache: 'no-store'}).then(function(res){
            if(!res.ok) {
              var err = new Error('HTTP ' + res.status);
              err.status = res.status;
              throw err;
            }
            return res.json();
          });
        }

        fetchJson(url)
          .catch(function(err){
            // If static media access is forbidden (403) or other error, retry with cache-busting query
            if(err && (err.status === 403 || err.message.indexOf('HTTP 403') !== -1 || err.name === 'TypeError')){
              var cbUrl = url + (url.indexOf('?') === -1 ? '?_cb=' + Date.now() : '&_cb=' + Date.now());
              return fetchJson(cbUrl).catch(function(err2){
                // If cache-busted attempt also fails, fall back to REST endpoint
                if(err2 && (err2.status === 403 || (err2.message && err2.message.indexOf('HTTP 403') !== -1))) {
                  return fetchJson(restUrl);
                }
                throw err2;
              });
            }
            throw err;
          })
          .then(function(data){
            if(Array.isArray(data)){
              function parseEvDate(ev){
                var dateStr = ev['Date'] || ev['date'] || '';
                var timeStr = ev['Start Time'] || ev['StartTime'] || ev['Start'] || '';
                var dt = null;
                if(dateStr.indexOf('/') !== -1){
                  var parts = dateStr.trim().split('/');
                  if(parts.length >= 2){
                    var day = parseInt(parts[0],10);
                    var month = parseInt(parts[1],10) - 1;
                    var year = parts[2] ? parts[2].trim() : '';
                    if(year.length === 2) year = 2000 + parseInt(year,10);
                    else if(year.length === 0) year = new Date().getFullYear();
                    else year = parseInt(year,10);
                    if(!isNaN(day) && !isNaN(month) && !isNaN(year)){
                      dt = new Date(year, month, day);
                    }
                  }
                } else if(dateStr){
                  var p = Date.parse(dateStr);
                  if(!isNaN(p)) dt = new Date(p);
                }
                if(dt && timeStr){
                  var m = timeStr.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?\s*([APMapm\.]*)/);
                  if(m){
                    var hh = parseInt(m[1],10);
                    var mm = parseInt(m[2],10) || 0;
                    var ss = m[3] ? parseInt(m[3],10) : 0;
                    var ampm = (m[4] || '').toLowerCase();
                    if(ampm.indexOf('p') !== -1 && hh < 12) hh += 12;
                    if(ampm.indexOf('a') !== -1 && hh === 12) hh = 0;
                    dt.setHours(hh, mm, ss, 0);
                  } else {
                    var m2 = timeStr.match(/^(\d{1,2}):(\d{2})$/);
                    if(m2) dt.setHours(parseInt(m2[1],10), parseInt(m2[2],10), 0, 0);
                  }
                }
                return dt ? dt.getTime() : null;
              }

              data.sort(function(a,b){
                var ta = parseEvDate(a);
                var tb = parseEvDate(b);
                if(ta === null && tb === null) return 0;
                if(ta === null) return 1;
                if(tb === null) return -1;
                return tb - ta; // descending: newest first
              });
            }
            renderEvents(data);
          })
          .catch(function(err){
            console.error('Failed to load event data from', url, err);
          });
      }

      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', loadData); else loadData();
    })();
  </script>

</div>

</body>
</html>
